<i18n-var/>
<script marko-init>
  const numberOfBankAccounts = require("../../lib/number-of-bank-accounts");
  const splitScheduleByDate = require("../../lib/split-schedule-by-date");
  const sortCodeToBankName = require("../../lib/sort-code-to-bank-name");
  const maskAccountNumber = require("../../utils/mask-account-number");
  const formatDate = require("../../lib/format-date");
</script>

<layout-use("../../common/layout.marko") errors=data.errors>

  <layout-put into="page-title">
    <i18n-message key="schedule:heading"/>
  </layout-put>

  <layout-put into="content">

    <await(schedule from data.schedulePromise)>
      <await-error>
        <p class="lede">
          <i18n-message key="schedule:await.error"/>
        </p>
      </await-error>
      <await-timeout>
        <p class="lede">
          <i18n-message key="schedule:await.timeout"/>
        </p>
      </await-timeout>

      <var currentStatus=schedule.statuses[schedule.statuses.length - 1]/>
      <var hasMultipleBankAccounts=(numberOfBankAccounts(schedule.paymentSchedule) > 1)/>
      <var split=splitScheduleByDate(schedule.paymentSchedule)/>
      <var paymentsPaid=split[0]/>
      <var paymentsDue=split[1]/>
      <var lastPayment=schedule.paymentSchedule[schedule.paymentSchedule.length - 1]/>

      <a href="/search?nino=${schedule.nationalInsuranceNumber}" class="link-back">
        <i18n-message key="schedule:backLink"/>
      </a>

      <h1 class="heading-xlarge schedule-heading">
        ${schedule.nationalInsuranceNumber}
        <span class="heading-secondary">
          <i18n-message key="schedule:${currentStatus.name}PaymentSchedule"/>
        </span>
      </h1>

      <ul if(currentStatus.name !== 'stopped') class="schedule-controls">
        <li>
          <a href="/edit-bank-details/${schedule.id}" class="button button-grey">
            <i18n-message key="schedule:editBankDetails"/>
          </a>
        </li>
        <li>
          <a href="/stop-schedule/${schedule.id}" class="button button-red">
            <i18n-message key="schedule:stop"/>
          </a>
        </li>
      </ul>

      <div class="grid-row">
        <div class="column-two-thirds">
          <table>
            <thead>
              <tr>
                <th colspan="2">
                  <i18n-message key="schedule:bankAccount"/>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><i18n-message key="schedule:nameOnAccount"/></td>
                <td>${lastPayment.bankAccount.nameOnAccount}</td>
              </tr>
              <tr>
                <td><i18n-message key="schedule:accountNumber"/></td>
                <td>${maskAccountNumber(lastPayment.bankAccount.accountNumber)}</td>
              </tr>
              <tr>
                <td><i18n-message key="schedule:sortCode"/></td>
                <td>${lastPayment.bankAccount.sortCode}</td>
              </tr>
              <tr>
                <td><i18n-message key="schedule:bankName"/></td>
                <td>${sortCodeToBankName(lastPayment.bankAccount.sortCode)}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="grid-row">

        <div class="column-one-half">
          <h2 class="heading-medium">
            <i18n-message key="schedule:pastPayments"/>
          </h2>
          <pay-schedule schedule=paymentsPaid
            is-empty-message-key="schedule:noPaymentsMade"
            mulitple-accounts=hasMultipleBankAccounts/>
        </div>

        <div class="column-one-half">
          <if(currentStatus.name === 'stopped')>
            <h2 class="heading-medium">
              <i18n-message key="schedule:paymentsStopped"/>
            </h2>
            <p class="schedule-label">
              <var stoppedDate=(new Date(currentStatus.startDate))/>
              <i18n-message key="schedule:paymentsStoppedMsg"
                timeStart='<time datetime="${stoppedDate.toISOString()}">'
                date=formatDate(stoppedDate)
                timeStop="</time>"/>
            </p>
            <pay-schedule schedule=paymentsDue/>
          </if>
          <else>
            <h2 class="heading-medium">
              <i18n-message key="schedule:futurePayments"/>
            </h2>
            <pay-schedule schedule=paymentsDue
              is-empty-message-key="schedule:noPaymentsMade"
              mulitple-accounts=hasMultipleBankAccounts/>
          </else>
        </div>

      </div>
    </await>

  </layout-put>

</layout-use>
